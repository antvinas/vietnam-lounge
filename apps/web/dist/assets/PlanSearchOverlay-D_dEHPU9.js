import{f as ee,g as te,e as ae,j as r}from"./index-DbUEaAMy.js";import{r as o}from"./react-Dp4Gqg7U.js";import{u as L,n as W}from"./plan.store-BbBRFP49.js";import{g as re,u as ne,t as k}from"./strings-CHsM0M4y.js";import"./firebase-Co7q5P-C.js";import"./firebase-CmtxdFcx.js";import{s as se}from"./spot.search-Bgh3s1s1.js";import"./firestore-DzFVOJbi.js";var le={};const oe="https://api.opentripmap.com/0.1/en";function ie(){const t=le.VITE_OPENTRIPMAP_API_KEY;if(!t)throw new Error("VITE_OPENTRIPMAP_API_KEY is missing");return t}const de={foods:"foods,restaurants",cafes:"cafes",sights:"interesting_places,sights,monuments,museums,architecture,urban_environment",shops:"shops,supermarkets,marketplaces",hotels:"accomodations,hotels,hostels"};async function ce(t){const{lat:I,lon:i}=t,y=t.radius,v=t.limit,c=ie(),f=new URLSearchParams({apikey:c,radius:String(y),lon:String(i),lat:String(I),limit:String(v),format:"json"});t.kinds&&f.set("kinds",t.kinds),f.set("rate",String(t.rate));const j=`${oe}/places/radius?${f.toString()}`,p=await fetch(j);if(!p.ok)throw new Error(`OpenTripMap radius search failed: ${p.status}`);return(await p.json()).map(l=>{var x,w;return{xid:l.xid,name:l.name,lat:((x=l.point)==null?void 0:x.lat)??l.lat,lon:((w=l.point)==null?void 0:w.lon)??l.lon,kinds:l.kinds,rate:l.rate,osm:l.osm}})}async function ue(t,I){if(!t)return[];if(typeof window>"u")return[];const i=window.google;return!i||!i.maps||!i.maps.places?(console.warn("[PlanSearchOverlay] google.maps.places 가 로드되지 않았습니다."),[]):await new Promise(y=>{try{const v=new i.maps.places.PlacesService(document.createElement("div")),c={query:t,region:"vn",language:"ko"};v.textSearch(c,(f,j)=>{if(j!==i.maps.places.PlacesServiceStatus.OK||!Array.isArray(f)){y([]);return}const p=f.map(g=>{var N;const l=(N=g.geometry)==null?void 0:N.location,x=typeof(l==null?void 0:l.lat)=="function"?l.lat():(l==null?void 0:l.lat)??void 0,w=typeof(l==null?void 0:l.lng)=="function"?l.lng():(l==null?void 0:l.lng)??void 0;return{id:g.place_id,place_id:g.place_id,name:g.name,address:g.formatted_address,location:x!=null&&w!=null?{lat:x,lng:w}:void 0,rating:g.rating,user_ratings_total:g.user_ratings_total,source:"google"}});y(p)})}catch(v){console.error("[PlanSearchOverlay] Google Places 검색 중 오류:",v),y([])}})}function ge(t){const i=L.getState().addItem;if(!t.tripId){console.error("[PlanSearchOverlay] addItemCompat: tripId가 없습니다.");return}const y=typeof t.lat=="number"&&typeof t.lng=="number",v=y&&t.lat!=null&&t.lng!=null?{placeId:t.placeId??W(),name:t.title,address:t.address,lat:t.lat,lng:t.lng}:void 0;try{if(typeof i=="function"&&i.length<=1)i({tripId:t.tripId,dayId:t.dayId,type:"activity",title:t.title,startTime:null,endTime:null,note:"",cost:typeof t.cost=="number"?t.cost:null,transportMode:null,placeId:void 0,googlePlace:v,insertAfterIndex:t.insertAfterIndex});else{const c=y&&t.lat!=null&&t.lng!=null?{lat:t.lat,lng:t.lng}:void 0;i(t.dayId,{title:t.title,spotId:null,location:c,cost:t.cost??0})}}catch(c){console.error("[PlanSearchOverlay] addItem 실패:",c)}}function ke(){const t=re(),I=ee(),i=te(),[y,v]=ae(),c=y.get("q")??"",f=y.get("dayId"),{currentDayId:j,setHoverSpotId:p,setCurrentDayId:g,selectedItemId:l}=ne(e=>({currentDayId:e.currentDayId,setHoverSpotId:e.setHoverSpotId,setCurrentDayId:e.setCurrentDayId,selectedItemId:e.selectedItemId})),x=L(e=>e.currentTripId),{itemsMap:w,placesMap:N,tripsMap:D,daysMap:S}=L(e=>({itemsMap:e.items,placesMap:e.places,tripsMap:e.trips,daysMap:e.days})),[m,E]=o.useState("google"),[R,T]=o.useState(!1),[$,M]=o.useState(!1),[q,O]=o.useState(!1),[B,G]=o.useState([]),[K,F]=o.useState([]),[U,C]=o.useState([]),J=o.useRef(null),V=o.useRef(null),H=o.useRef(null);o.useEffect(()=>{f&&f!==j&&(g==null||g(f))},[f,j,g]),o.useEffect(()=>{const e=n=>{var a,s;if(n.key==="Escape"){const u=((a=i.state)==null?void 0:a.background)||((s=i.state)==null?void 0:s.backgroundLocation);I(u??"/plan",{replace:!0})}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[i.state,I]);const h=f||j,A=o.useMemo(()=>{if(!h)return null;const e=S==null?void 0:S[h];if(!e)return null;const n=typeof e.order=="number"?`${e.order+1}일차`:"",a=typeof e.dateISO=="string"?e.dateISO:"";return n&&a?`${n} · ${a}`:n||a||null},[h,S]),b=o.useMemo(()=>{if(h){const e=Object.values(w||{}).filter(a=>a.dayId===h),n=[];for(const a of e){if(!a.placeId)continue;const s=N[a.placeId];s&&typeof s.lat=="number"&&typeof s.lng=="number"&&n.push({lat:s.lat,lng:s.lng})}if(n.length>0){const a=n.reduce((u,d)=>u+d.lat,0)/n.length,s=n.reduce((u,d)=>u+d.lng,0)/n.length;return{lat:a,lng:s}}}if(x){const e=D[x],n=(e==null?void 0:e.baseHotelPlaceId)??(e==null?void 0:e.baseHotelId);if(n){const a=N[n];if(a&&typeof a.lat=="number"&&typeof a.lng=="number")return{lat:a.lat,lng:a.lng}}}return null},[h,w,N,D,x]);o.useEffect(()=>{var a;if(!c){G([]),T(!1);return}T(!0),(a=V.current)==null||a.abort();const e=new AbortController;V.current=e;const n=setTimeout(async()=>{try{const s=await ue(c,e.signal);G(s)}catch{}finally{T(!1)}},300);return()=>{clearTimeout(n),e.abort()}},[c]),o.useEffect(()=>{var a;if(!c){F([]),M(!1);return}M(!0),(a=H.current)==null||a.abort();const e=new AbortController;H.current=e;const n=setTimeout(async()=>{try{const u=(await se("explorer",c)).map(d=>{const P=d.latitude,z=d.longitude;return{id:d.id,name:d.name,address:d.address,location:typeof P=="number"&&typeof z=="number"?{lat:P,lng:z}:void 0,rating:d.rating,reviewCount:d.reviewCount,source:"spot",spotId:d.id,price:d.averageSpend}});F(u)}catch{}finally{M(!1)}},300);return()=>{clearTimeout(n),e.abort()}},[c]),o.useEffect(()=>{if(m!=="poi")return;if(!b){C([]),O(!1);return}O(!0);let e=!1;return(async()=>{try{const n=await ce({lat:b.lat,lon:b.lng,radius:5e3,kinds:de.sights,limit:40,rate:2});if(e)return;const a=n.map(s=>({id:s.xid,name:s.name||"관광지",address:s.kinds,location:{lat:s.lat,lng:s.lon},source:"poi",poiId:s.xid,rate:s.rate}));C(a)}catch(n){e||(console.error("[PlanSearchOverlay] OpenTripMap 검색 오류:",n),C([]))}finally{e||O(!1)}})(),()=>{e=!0}},[m,b==null?void 0:b.lat,b==null?void 0:b.lng]);const Q=o.useCallback(e=>{e.preventDefault();const n=e.currentTarget.q;v(a=>{const s=new URLSearchParams(a);return n.value?s.set("q",n.value):s.delete("q"),s})},[v]),_=o.useCallback(()=>{var n,a;const e=((n=i.state)==null?void 0:n.background)||((a=i.state)==null?void 0:a.backgroundLocation);I(e??"/plan",{replace:!0})},[i.state,I]),X=o.useCallback(e=>{var d;if(!h){window.alert(k(t,"search","selectDayWarning")??"먼저 일차를 선택한 뒤 장소를 추가해 주세요.");return}let n=-1;if(l&&h&&S){const P=S[h];P&&Array.isArray(P.itemIds)&&(n=P.itemIds.indexOf(l))}const a=e.location??((d=e.geometry)==null?void 0:d.location)??null;let s,u;a&&(s=typeof a.lat=="function"?a.lat():a.lat??a.latitude,u=typeof a.lng=="function"?a.lng():a.lng??a.longitude),s==null&&e.lat!=null&&(s=e.lat),u==null&&e.lng!=null&&(u=e.lng),s==null&&e.latitude!=null&&(s=e.latitude),u==null&&e.longitude!=null&&(u=e.longitude),ge({dayId:h,tripId:x??null,title:e.name??e.title??"스팟",lat:s,lng:u,cost:e.price??e.averageSpend??0,address:e.address??e.formatted_address,source:e.source,placeId:e.place_id,spotId:e.spotId??(e.source==="spot"?e.id:void 0),poiId:e.poiId??(e.source==="poi"?e.id:void 0),insertAfterIndex:n}),_()},[h,x,_,t,l,S]),Y=o.useMemo(()=>m==="google"?B:m==="spot"?K:U,[m,B,K,U]),Z=o.useMemo(()=>m==="google"?R:m==="spot"?$:q,[m,R,$,q]);return r.jsxs("div",{role:"dialog","aria-modal":"true",className:"fixed inset-0 z-50",onClick:e=>{e.target===e.currentTarget&&_()},children:[r.jsx("div",{className:"absolute inset-0 bg-black/40"}),r.jsxs("div",{className:"absolute inset-x-0 top-10 mx-auto w-full max-w-3xl overflow-hidden rounded-xl bg-white shadow-xl ring-1 ring-black/10 dark:bg-gray-900",children:[r.jsx("div",{className:"border-b px-4 py-3 dark:border-gray-800",children:r.jsxs("div",{className:"flex items-center justify-between gap-3",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-50",children:k(t,"search","title")??"장소 검색"}),r.jsx("div",{className:"mt-0.5 text-xs text-gray-500 dark:text-gray-400",children:A?r.jsxs(r.Fragment,{children:["현재 선택된 일정: ",A]}):r.jsx(r.Fragment,{children:"먼저 일차를 선택하거나 생성한 뒤 장소를 추가해 주세요."})})]}),r.jsx("button",{type:"button",onClick:_,className:"rounded-full border px-2.5 py-1 text-xs text-gray-500 hover:bg-gray-50 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800",children:k(t,"search","closeButton")??"닫기"})]})}),r.jsxs("form",{onSubmit:Q,className:"flex items-center gap-2 border-b px-4 py-2.5 dark:border-gray-800",children:[r.jsx("input",{ref:J,name:"q",defaultValue:c,autoFocus:!0,placeholder:k(t,"search","placeholder")??"장소 이름, 카페, 명소 등을 입력하세요",className:"flex-1 rounded-md border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-50 dark:placeholder:text-gray-500"}),r.jsx("button",{type:"submit",className:"rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700",children:k(t,"search","searchButton")??"검색"})]}),r.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-2 text-xs dark:border-gray-800",children:[r.jsxs("div",{className:"flex gap-1.5",children:[r.jsx("button",{type:"button",onClick:()=>E("google"),className:`rounded-full px-3 py-1 text-xs font-medium ${m==="google"?"bg-blue-600 text-white shadow-sm":"bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"}`,children:"Google"}),r.jsx("button",{type:"button",onClick:()=>E("spot"),className:`rounded-full px-3 py-1 text-xs font-medium ${m==="spot"?"bg-blue-600 text-white shadow-sm":"bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"}`,children:"내 스팟"}),r.jsx("button",{type:"button",onClick:()=>E("poi"),className:`rounded-full px-3 py-1 text-xs font-medium ${m==="poi"?"bg-emerald-600 text-white shadow-sm":"bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"}`,children:"관광지 추천"})]}),m==="poi"&&b&&r.jsx("span",{className:"hidden text-[11px] text-gray-400 sm:inline",children:"현재 일정 주변 약 5km 반경 기준 추천"})]}),r.jsxs("div",{className:"max-h-[70vh] overflow-y-auto bg-white dark:bg-gray-900",children:[m==="poi"&&!b&&r.jsx("div",{className:"px-4 pt-3 text-xs text-amber-600 dark:text-amber-300",children:"현재 Day에 등록된 장소나 기준 위치가 없어서 주변 관광지를 찾기 어렵습니다. 먼저 하루 일정에 최소 한 곳 이상을 추가해 주세요."}),Z?r.jsx("div",{className:"p-4 text-sm text-gray-500 dark:text-gray-400",children:k(t,"search","loading")??"검색 중입니다..."}):Y.length===0?r.jsx("div",{className:"p-4 text-sm text-gray-500 dark:text-gray-400",children:k(t,"search","empty")??"검색 결과가 없습니다."}):r.jsx("ul",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:Y.map(e=>r.jsxs("li",{className:"flex items-start justify-between gap-3 p-4 hover:bg-gray-50 dark:hover:bg-gray-800/80",onMouseEnter:()=>p==null?void 0:p(e.id??e.place_id),onMouseLeave:()=>p==null?void 0:p(null),children:[r.jsxs("div",{className:"min-w-0 flex-1",children:[r.jsx("div",{className:"truncate text-sm font-semibold text-gray-900 dark:text-gray-50",children:e.name??e.title}),r.jsx("div",{className:"mt-0.5 line-clamp-2 text-xs text-gray-500 dark:text-gray-400",children:e.address??e.formatted_address??""}),r.jsxs("div",{className:"mt-1 flex flex-wrap gap-2 text-[11px] text-gray-400 dark:text-gray-500",children:[e.source==="google"&&e.user_ratings_total!=null&&r.jsxs("span",{children:["리뷰 ",e.user_ratings_total,"개",e.rating&&` · ★ ${Number(e.rating).toFixed(1)}`]}),e.source==="spot"&&(e.reviewCount!=null||e.rating!=null)&&r.jsxs("span",{children:["내 스팟 · 리뷰 ",e.reviewCount??0,"개",e.rating&&` · ★ ${Number(e.rating).toFixed(1)}`]}),e.source==="poi"&&e.rate!=null&&r.jsxs("span",{className:"text-emerald-600 dark:text-emerald-300",children:["추천 지수 ",e.rate]})]})]}),r.jsx("button",{type:"button",className:"shrink-0 rounded-md border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-800 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-100 dark:hover:bg-gray-800",onClick:()=>X(e),children:k(t,"search","addButton")??"추가"})]},e.id??e.place_id??W()))})]}),r.jsxs("div",{className:"flex justify-between border-t px-4 py-2 text-[11px] text-gray-400 dark:border-gray-800 dark:text-gray-500",children:[r.jsx("span",{children:k(t,"search","tip")??"Tip: Enter로 검색, ESC로 닫기"}),A&&r.jsx("span",{children:"이 일정에 추가된 장소는 지도와 경로에 바로 반영됩니다."})]})]})]})}export{ke as default};
